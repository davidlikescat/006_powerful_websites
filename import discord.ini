import discord
import asyncio
import re
from sub1 import extract_text_from_url, gemini_extract_notion_fields, flatten_fields_for_airtable
from sub2 import send_to_airtable, send_to_telegram
from sub3 import process_script_to_tts_google_drive  # Google Drive TTS ì‚¬ìš©
import os
from dotenv import load_dotenv
import json

# í™˜ê²½ ë³€ìˆ˜ ë¡œë“œ
load_dotenv()

# Discord ì„¤ì •
TOKEN = os.getenv('DISCORD_TOKEN')
CHANNEL_ID = int(os.getenv('DISCORD_CHANNEL_ID'))

# API í‚¤ ì„¤ì •
GEMINI_API_KEY = os.getenv('GEMINI_API_KEY')
TELEGRAM_BOT_TOKEN = os.getenv('TELEGRAM_BOT_TOKEN')
TELEGRAM_CHAT_ID = os.getenv('TELEGRAM_CHAT_ID')

# Airtable ì„¤ì •
AIRTABLE_API_KEY = os.getenv('AIRTABLE_API_KEY')
AIRTABLE_BASE_ID = os.getenv('AIRTABLE_BASE_ID')
AIRTABLE_TABLE_NAME = os.getenv('AIRTABLE_TABLE_NAME')

# Discord í´ë¼ì´ì–¸íŠ¸ ì„¤ì •
intents = discord.Intents.default()
intents.messages = True
intents.message_content = True
client = discord.Client(intents=intents)

async def process_url(url):
    try:
        print("=" * 50)
        print(f"URL ì²˜ë¦¬ ì‹œì‘: {url}")
        
        # 1. í…ìŠ¤íŠ¸ ì¶”ì¶œ
        print("1. í…ìŠ¤íŠ¸ ì¶”ì¶œ ì¤‘...")
        text = extract_text_from_url(url)
        print(f"ì¶”ì¶œëœ í…ìŠ¤íŠ¸ ê¸¸ì´: {len(text)}")
        
        # 2. Gemini ë¶„ì„
        print("2. Gemini ë¶„ì„ ì¤‘...")
        notion_data = gemini_extract_notion_fields(text, url, GEMINI_API_KEY)
        print(f"Gemini ê²°ê³¼: {json.dumps(notion_data, ensure_ascii=False, indent=2)}")
        
        # 3. Airtableìš© ë³€í™˜
        print("3. Airtableìš© ë°ì´í„° ë³€í™˜ ì¤‘...")
        filtered_data = flatten_fields_for_airtable(notion_data)
        print(f"ë³€í™˜ í›„ ì¹´í…Œê³ ë¦¬: '{filtered_data.get('ì¹´í…Œê³ ë¦¬')}' (íƒ€ì…: {type(filtered_data.get('ì¹´í…Œê³ ë¦¬'))})")
        print(f"ìµœì¢… ì „ì†¡ ë°ì´í„°: {json.dumps(filtered_data, ensure_ascii=False, indent=2)}")
        
        # 4. TTS ì²˜ë¦¬
        print("4. ì˜ì–´ ìŠ¤í¬ë¦½íŠ¸ TTS ë³€í™˜ ì¤‘...")
        english_script = filtered_data.get('Script', '')
        
        if english_script and english_script.strip():
            tts_result = process_script_to_tts_google_drive(
                english_script, 
                voice_name="en-US-Journey-F"  # ì—¬ì„±, ë”°ëœ»í•˜ê³  ìì—°ìŠ¤ëŸ¬ìš´
            )
            
            if tts_result["success"]:
                print(f"âœ… TTS ë³€í™˜ ì„±ê³µ: {tts_result['audio_url']}")
                # TTS URLì„ ë°ì´í„°ì— ì¶”ê°€
                filtered_data["TTS_URL"] = tts_result["audio_url"]
                filtered_data["TTS_íŒŒì¼ëª…"] = tts_result["filename"]
                filtered_data["Drive_íŒŒì¼ID"] = tts_result.get("file_id", "")
            else:
                print("âŒ TTS ë³€í™˜ ì‹¤íŒ¨")
                filtered_data["TTS_URL"] = "TTS ìƒì„± ì‹¤íŒ¨"
                filtered_data["TTS_íŒŒì¼ëª…"] = ""
                filtered_data["Drive_íŒŒì¼ID"] = ""
        else:
            print("âš ï¸ ì˜ì–´ ìŠ¤í¬ë¦½íŠ¸ê°€ ì—†ì–´ì„œ TTS ê±´ë„ˆëœ€")
            filtered_data["TTS_URL"] = "ìŠ¤í¬ë¦½íŠ¸ ì—†ìŒ"
            filtered_data["TTS_íŒŒì¼ëª…"] = ""
            filtered_data["Drive_íŒŒì¼ID"] = ""
        
        # 5. Airtable ì „ì†¡
        print("5. Airtable ì „ì†¡ ì¤‘...")
        airtable_success = send_to_airtable(AIRTABLE_API_KEY, AIRTABLE_BASE_ID, AIRTABLE_TABLE_NAME, filtered_data)
        
        # 6. í…”ë ˆê·¸ë¨ ì „ì†¡
        if airtable_success:
            print("6. í…”ë ˆê·¸ë¨ ì „ì†¡ ì¤‘...")
            telegram_msg = f"ğŸ“ ìƒˆë¡œìš´ ì›¹ì‚¬ì´íŠ¸ ì •ë³´\n\n{filtered_data.get('ìš”ì•½ ì„¤ëª…', '')}\n\n{filtered_data.get('URL', url)}"
            
            # TTS URLì´ ìˆìœ¼ë©´ í…”ë ˆê·¸ë¨ ë©”ì‹œì§€ì— ì¶”ê°€
            if filtered_data.get("TTS_URL") and "http" in filtered_data.get("TTS_URL", ""):
                telegram_msg += f"\n\nğŸ™ï¸ ì˜ì–´ ìŒì„±: {filtered_data['TTS_URL']}"
            
            telegram_success = send_to_telegram(TELEGRAM_BOT_TOKEN, TELEGRAM_CHAT_ID, telegram_msg)
            return telegram_success
        else:
            print("âŒ Airtable ì €ì¥ ì‹¤íŒ¨ë¡œ í…”ë ˆê·¸ë¨ ì „ì†¡ ê±´ë„ˆëœ€")
            return False
            
    except Exception as e:
        print(f"âŒ ì—ëŸ¬ ë°œìƒ: {str(e)}")
        import traceback
        print(traceback.format_exc())
        return False

@client.event
async def on_ready():
    print(f'{client.user} has connected to Discord!')

@client.event
async def on_message(message):
    print("on_message ì´ë²¤íŠ¸ ê°ì§€ë¨")
    if message.channel.id == CHANNEL_ID and message.author != client.user:
        print(f"ë©”ì‹œì§€ ê°ì§€: {message.content}")
        urls = re.findall(r'(https?://[^\s]+)', message.content)
        for url in urls:
            print(f"URL ê°ì§€: {url}")
            status_msg = await message.channel.send(f'ğŸ”„ **ì›¹ì‚¬ì´íŠ¸ ìš”ì•½ì„ ì‹œì‘í•©ë‹ˆë‹¤!**\nURL: {url}')
            try:
                print("=" * 50)
                print(f"URL ì²˜ë¦¬ ì‹œì‘: {url}")
                
                # 1. í…ìŠ¤íŠ¸ ì¶”ì¶œ
                print("1. ë³¸ë¬¸ í¬ë¡¤ë§ ì‹œì‘")
                text = extract_text_from_url(url)
                print(f"ì¶”ì¶œëœ í…ìŠ¤íŠ¸ ê¸¸ì´: {len(text)}")
                
                # 2. Gemini ë¶„ì„
                print("2. Gemini ìš”ì•½ ì‹œì‘")
                notion_data = gemini_extract_notion_fields(text, url, GEMINI_API_KEY)
                print(f"Gemini ì›ë³¸ ê²°ê³¼: {json.dumps(notion_data, ensure_ascii=False, indent=2)}")
                
                # 3. Airtableìš© ë³€í™˜
                print("3. Airtableìš© ë°ì´í„° ë³€í™˜")
                filtered_data = flatten_fields_for_airtable(notion_data)
                print("=" * 30)
                print(f"ìµœì¢… Airtable ì „ì†¡ ë°ì´í„°:")
                print(f"ì¹´í…Œê³ ë¦¬: '{filtered_data.get('ì¹´í…Œê³ ë¦¬')}' (íƒ€ì…: {type(filtered_data.get('ì¹´í…Œê³ ë¦¬'))})")
                print(f"ì „ì²´ ë°ì´í„°: {json.dumps(filtered_data, ensure_ascii=False, indent=2)}")
                print("=" * 30)
                
                # 4. TTS ì²˜ë¦¬
                print("4. ì˜ì–´ ìŠ¤í¬ë¦½íŠ¸ TTS ë³€í™˜ ì¤‘...")
                english_script = filtered_data.get('Script', '')
                
                if english_script and english_script.strip():
                    await status_msg.edit(content=f'ğŸ™ï¸ **TTS ìŒì„± ìƒì„± ì¤‘...**\nURL: {url}')
                    
                    tts_result = process_script_to_tts_google_drive(
                        english_script, 
                        voice_name="en-US-Journey-F"  # ì—¬ì„±, ë”°ëœ»í•˜ê³  ìì—°ìŠ¤ëŸ¬ìš´
                    )
                    
                    if tts_result["success"]:
                        print(f"âœ… TTS ë³€í™˜ ì„±ê³µ: {tts_result['audio_url']}")
                        # TTS URLì„ ë°ì´í„°ì— ì¶”ê°€
                        filtered_data["TTS_URL"] = tts_result["audio_url"]
                        filtered_data["TTS_íŒŒì¼ëª…"] = tts_result["filename"]
                        filtered_data["Drive_íŒŒì¼ID"] = tts_result.get("file_id", "")
                    else:
                        print("âŒ TTS ë³€í™˜ ì‹¤íŒ¨")
                        filtered_data["TTS_URL"] = "TTS ìƒì„± ì‹¤íŒ¨"
                        filtered_data["TTS_íŒŒì¼ëª…"] = ""
                        filtered_data["Drive_íŒŒì¼ID"] = ""
                else:
                    print("âš ï¸ ì˜ì–´ ìŠ¤í¬ë¦½íŠ¸ê°€ ì—†ì–´ì„œ TTS ê±´ë„ˆëœ€")
                    filtered_data["TTS_URL"] = "ìŠ¤í¬ë¦½íŠ¸ ì—†ìŒ"
                    filtered_data["TTS_íŒŒì¼ëª…"] = ""
                    filtered_data["Drive_íŒŒì¼ID"] = ""
                
                # 5. Airtable ì „ì†¡
                print("5. Airtable ì „ì†¡ ì‹œë„")
                await status_msg.edit(content=f'ğŸ’¾ **Airtable ì €ì¥ ì¤‘...**\nURL: {url}')
                
                airtable_success = send_to_airtable(AIRTABLE_API_KEY, AIRTABLE_BASE_ID, AIRTABLE_TABLE_NAME, filtered_data)
                
                if not airtable_success:
                    print("âŒ Airtable ì €ì¥ ì‹¤íŒ¨!")
                    await status_msg.edit(content=f"âŒ Airtable ì €ì¥ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤. í„°ë¯¸ë„ ë¡œê·¸ë¥¼ í™•ì¸í•˜ì„¸ìš”.")
                    return
                
                print("âœ… Airtable ì €ì¥ ì„±ê³µ!")
                
                # 6. í…”ë ˆê·¸ë¨ ì „ì†¡
                print("6. í…”ë ˆê·¸ë¨ ì „ì†¡ ì‹œë„")
                telegram_msg = f"ğŸ“ ìƒˆë¡œìš´ ì›¹ì‚¬ì´íŠ¸ ì •ë³´\n\n{filtered_data.get('ìš”ì•½ ì„¤ëª…', '')}\n\n{filtered_data.get('URL', url)}"
                
                # TTS URLì´ ìˆìœ¼ë©´ í…”ë ˆê·¸ë¨ ë©”ì‹œì§€ì— ì¶”ê°€
                if filtered_data.get("TTS_URL") and "http" in filtered_data.get("TTS_URL", ""):
                    telegram_msg += f"\n\nğŸ™ï¸ ì˜ì–´ ìŒì„±: {filtered_data['TTS_URL']}"
                
                telegram_success = send_to_telegram(TELEGRAM_BOT_TOKEN, TELEGRAM_CHAT_ID, telegram_msg)
                
                print("7. ëª¨ë“  ì‘ì—… ì™„ë£Œ")
                
                # 7. ì„±ê³µ ë©”ì‹œì§€(Embed) - TTS ì •ë³´ í¬í•¨
                embed = discord.Embed(
                    title="âœ… ì›¹ì‚¬ì´íŠ¸ ìš”ì•½/ì €ì¥ ì™„ë£Œ!",
                    description=f"**{filtered_data.get('ì‚¬ì´íŠ¸ ì´ë¦„', '')}**\n{filtered_data.get('ìš”ì•½ ì„¤ëª…', '')}",
                    color=0x2ecc71
                )
                embed.add_field(name="ì¹´í…Œê³ ë¦¬", value=filtered_data.get('ì¹´í…Œê³ ë¦¬', '-') or "-", inline=True)
                embed.add_field(name="í‰ê°€/íš¨ìš©ì„±", value=filtered_data.get('í‰ê°€/íš¨ìš©ì„±', '-') or "-", inline=True)
                embed.add_field(name="í™œìš© ì‚¬ë¡€", value=filtered_data.get('í™œìš© ì‚¬ë¡€', '-') or "-", inline=True)
                embed.add_field(name="í•œêµ­ì–´ ìŠ¤í¬ë¦½íŠ¸", value="âœ… ì™„ë£Œ", inline=True)
                embed.add_field(name="ì˜ì–´ ìŠ¤í¬ë¦½íŠ¸", value="âœ… ì™„ë£Œ", inline=True)
                
                # TTS ê²°ê³¼ í‘œì‹œ
                tts_status = "âœ… ì™„ë£Œ" if filtered_data.get("TTS_URL") and "http" in filtered_data.get("TTS_URL", "") else "âŒ ì‹¤íŒ¨"
                embed.add_field(name="ì˜ì–´ TTS ìŒì„±", value=tts_status, inline=True)
                
                embed.add_field(name="Airtable ì €ì¥", value="âœ… ì„±ê³µ", inline=False)
                embed.add_field(name="í…”ë ˆê·¸ë¨ ì „ì†¡", value="âœ… ì„±ê³µ" if telegram_success else "âŒ ì‹¤íŒ¨", inline=False)
                
                # TTS URLì´ ìˆìœ¼ë©´ ì„ë² ë“œì— ì¶”ê°€
                if filtered_data.get("TTS_URL") and "http" in filtered_data.get("TTS_URL", ""):
                    embed.add_field(name="ğŸ™ï¸ ì˜ì–´ ìŒì„± íŒŒì¼", value=f"[ì¬ìƒí•˜ê¸°]({filtered_data['TTS_URL']})", inline=False)
                
                embed.set_footer(text=f"URL: {filtered_data.get('URL', url)}")
                await status_msg.edit(content=None, embed=embed)
                
            except Exception as e:
                print(f"âŒ ì—ëŸ¬ ë°œìƒ: {str(e)}")
                import traceback
                print(traceback.format_exc())
                await status_msg.edit(content=f"âŒ ì²˜ë¦¬ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: {str(e)}")

if __name__ == "__main__":
    client.run(TOKEN)